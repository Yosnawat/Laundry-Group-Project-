<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machine Details - Laundry Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background: #F3F4F6; }
        .rating-star { color: #FBBF24; }
        .rating-star.empty { color: #D1D5DB; }
    </style>
</head>
<body class="min-h-screen p-6 flex justify-center items-center">

    <div class="max-w-4xl w-full bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
            <a href="javascript:history.back()" class="text-blue-600 font-semibold flex items-center hover:underline">
                ‚Üê Back to Dashboard
            </a>
            <span th:if="${currentUser != null}" class="text-gray-500 text-sm" th:text="${currentUser.name}">User</span>
        </div>

        <div class="md:flex">
            <div class="md:w-1/3 bg-blue-50 p-8 flex flex-col items-center text-center border-r border-blue-100">
                <div class="w-40 h-40 bg-white rounded-full flex items-center justify-center shadow-md mb-6 text-6xl">
                    <span th:if="${machine.machineType == 'WASHER'}">üßº</span>
                    <span th:if="${machine.machineType == 'DRYER'}">üî•</span>
                </div>
                <h1 class="text-3xl font-bold text-gray-800 mb-1" th:text="${machine.name}">Washer A</h1>
                <p class="text-blue-600 font-semibold mb-6" th:text="${machine.machineNumber}">W-001</p>
                
                <div class="bg-white p-4 rounded-xl shadow-sm w-full mb-4">
                    <p class="text-sm text-gray-500 mb-1">Status</p>
                    <span class="px-3 py-1 rounded-full text-sm font-bold"
                          th:classappend="${machine.status == 'AVAILABLE' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}"
                          th:text="${machine.status}">AVAILABLE</span>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm w-full">
                    <p class="text-sm text-gray-500 mb-1">Price per Load</p>
                    <p class="text-2xl font-bold text-gray-800" th:text="${machine.pricePerHour + ' ‡∏ø'}">40 ‡∏ø</p>
                </div>
            </div>

            <div class="md:w-2/3 p-8">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h2 class="text-xl font-bold text-gray-800 mb-2">Specifications</h2>
                        <div class="grid grid-cols-2 gap-x-8 gap-y-2 text-sm">
                            <div><span class="text-gray-500">Brand:</span> <span class="font-medium" th:text="${machine.brand ?: 'N/A'}">Samsung</span></div>
                            <div><span class="text-gray-500">Model:</span> <span class="font-medium" th:text="${machine.model ?: 'N/A'}">WF-5000</span></div>
                            <div><span class="text-gray-500">Type:</span> <span class="font-medium" th:text="${machine.machineType}">WASHER</span></div>
                            <div><span class="text-gray-500">Capacity:</span> <span class="font-medium" th:text="${machine.capacity != null ? machine.capacity + ' kg' : 'N/A'}">10 kg</span></div>
                        </div>
                    </div>
                    
                    <div class="bg-amber-50 border border-amber-100 rounded-xl p-3 text-center">
                        <div class="text-3xl font-bold text-amber-500" th:text="${#numbers.formatDecimal(averageRating, 1, 1)}">4.5</div>
                        <div class="flex text-lg">
                             <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                   class="rating-star" 
                                   th:classappend="${i > averageRating} ? 'empty'">‚òÖ</span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1" th:text="${totalRatings + ' reviews'}">120 reviews</p>
                    </div>
                </div>

                <div class="mb-8">
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Description</h2>
                    <p class="text-gray-600 leading-relaxed" th:text="${machine.description ?: 'No description available for this machine.'}">
                        High-efficiency front-load washer with steam cycle for deep cleaning.
                    </p>
                </div>

                <a th:if="${machine.status == 'AVAILABLE' and currentUser != null and currentUser.role.toString() != 'MANAGER'}"
                   th:href="@{/student/{uid}/booking?machineId={mid}(uid=${currentUser.studentId}, mid=${machine.id})}"
                   class="block w-full py-4 bg-blue-600 hover:bg-blue-700 text-white text-center font-bold rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    Book This Machine Now
                </a>
                
                <button th:if="${currentUser != null and currentUser.role.toString() == 'MANAGER'}"
                        onclick="openEditModal()"
                        class="block w-full py-4 bg-purple-600 hover:bg-purple-700 text-white text-center font-bold rounded-xl transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-1">
                    Edit Machine Details (Admin)
                </button>
                
                <button th:if="${machine.status != 'AVAILABLE' and (currentUser == null or currentUser.role.toString() != 'MANAGER')}" disabled
                        class="block w-full py-4 bg-gray-300 text-gray-500 text-center font-bold rounded-xl cursor-not-allowed">
                    Currently Unavailable
                </button>

                <div class="mt-10 pt-8 border-t">
                    <h3 class="text-lg font-bold text-gray-800 mb-4">Recent Reviews</h3>
                    <div class="space-y-4 max-h-64 overflow-y-auto pr-2">
                        <div th:each="review : ${recentReviews}" class="bg-gray-50 p-4 rounded-lg">
                            <div class="flex justify-between mb-1">
                                <span class="font-semibold text-sm" th:text="${review.userName}">User Name</span>
                                <div class="flex text-amber-400 text-sm">
                                    <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                          th:text="${i <= review.rating ? '‚òÖ' : '‚òÜ'}"></span>
                                </div>
                            </div>
                            <p class="text-gray-600 text-sm italic" th:text="|&quot;${review.reviewText}&quot;|">"Great machine!"</p>
                            <p class="text-xs text-gray-400 mt-2" th:text="${#temporals.format(review.createdAt, 'dd MMM yyyy')}">Date</p>
                        </div>
                        <p th:if="${#lists.isEmpty(recentReviews)}" class="text-gray-500 text-sm italic">No reviews yet.</p>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Edit Machine Modal (Admin Only) -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b bg-purple-50">
                <h2 class="text-2xl font-bold text-purple-800">Edit Machine Details</h2>
            </div>
            <div class="p-6">
                <form id="editMachineForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Machine Name</label>
                            <input type="text" id="editName" th:value="${machine.name}" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Machine Type</label>
                            <select id="editMachineType" th:value="${machine.machineType}" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="WASHER" th:selected="${machine.machineType == 'WASHER'}">Washer</option>
                                <option value="DRYER" th:selected="${machine.machineType == 'DRYER'}">Dryer</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Brand</label>
                            <input type="text" id="editBrand" th:value="${machine.brand}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Model</label>
                            <input type="text" id="editModel" th:value="${machine.model}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Capacity (kg)</label>
                            <input type="text" id="editCapacity" th:value="${machine.capacity}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Location</label>
                            <input type="text" id="editLocation" th:value="${machine.location}" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Status</label>
                            <select id="editStatus" th:value="${machine.status}" required
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                <option value="AVAILABLE" th:selected="${machine.status == 'AVAILABLE'}">Available</option>
                                <option value="IN_USE" th:selected="${machine.status == 'IN_USE'}">In Use</option>
                                <option value="OUT_OF_SERVICE" th:selected="${machine.status == 'OUT_OF_SERVICE'}">Out of Service</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Price per Hour (‡∏ø)</label>
                            <input type="number" step="0.01" id="editPricePerHour" th:value="${machine.pricePerHour}" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1">Price per Day (‡∏ø)</label>
                            <input type="number" step="0.01" id="editPricePerDay" th:value="${machine.pricePerDay}" required
                                   class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Description</label>
                        <textarea id="editDescription" rows="3" th:text="${machine.description}"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent"></textarea>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-1">Features (comma-separated)</label>
                        <input type="text" id="editFeatures" th:value="${machine.features}" 
                               placeholder="e.g., Steam wash, Quick dry, Energy efficient"
                               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                    </div>
                </form>
            </div>
            <div class="p-6 border-t bg-gray-50 flex gap-3">
                <button onclick="closeEditModal()" type="button"
                        class="flex-1 px-6 py-3 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition">
                    Cancel
                </button>
                <button onclick="saveChanges()" type="button"
                        class="flex-1 px-6 py-3 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition">
                    Save Changes
                </button>
            </div>
        </div>
    </div>

    <script>
        const machineId = 0;
        
        function openEditModal() {
            document.getElementById('editModal').classList.remove('hidden');
        }
        
        function closeEditModal() {
            document.getElementById('editModal').classList.add('hidden');
        }
        
        async function saveChanges() {
            const data = {
                name: document.getElementById('editName').value,
                machineType: document.getElementById('editMachineType').value,
                brand: document.getElementById('editBrand').value,
                model: document.getElementById('editModel').value,
                capacity: document.getElementById('editCapacity').value,
                location: document.getElementById('editLocation').value,
                status: document.getElementById('editStatus').value,
                pricePerHour: parseFloat(document.getElementById('editPricePerHour').value),
                pricePerDay: parseFloat(document.getElementById('editPricePerDay').value),
                description: document.getElementById('editDescription').value,
                features: document.getElementById('editFeatures').value
            };
            
            try {
                const response = await fetch(`/api/machines/${machineId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    alert('Machine updated successfully!');
                    location.reload();
                } else {
                    const error = await response.text();
                    alert('Error updating machine: ' + error);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }
        
        // Close modal when clicking outside
        document.getElementById('editModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeEditModal();
            }
        });
    </script>
</body>
</html>