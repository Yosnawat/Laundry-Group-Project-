<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Laundry System - Dashboard</title>

    <meta name="_csrf" th:content="${_csrf?.token}"/>
    <meta name="_csrf_header" th:content="${_csrf?.headerName}"/>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
        rel="stylesheet"
    />
    <style>
        /* (CSS เดิม) */
        body {
            font-family: "Poppins", sans-serif;
            background: #e7f5ff;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
        }
        .app-container {
            max-width: 1000px;
            width: 95%;
            margin: 20px auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }
        .view {
            display: none;
            padding: 30px 40px;
        }
        .primary-btn {
            padding: 14px;
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .primary-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 123, 255, 0.4);
            filter: brightness(1.1);
        }
        .primary-btn:active {
            transform: translateY(0);
        }
        .tab-btn {
            display: inline-block;
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s;
            font-weight: 500;
            text-decoration: none;
            border-bottom-width: 2px;
            border-color: transparent;
        }
        .tab-btn:hover {
            border-color: #9ca3af;
            color: #333;
        }
        .tab-btn.active {
            color: #007bff;
            font-weight: 600;
            border-color: #007bff;
        }
        .card {
            background: white;
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        .update-machine-btn {
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
        }
        .admin-slot-btn {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 6px;
            font-weight: 600;
            transition: all 0.2s;
        }
        .admin-btn-available {
            background-color: #ecfdf5;
            color: #067647; border: 1px solid #a7f3d0;
        }
        .admin-btn-available:hover {
            background-color: #d1fae5;
            color: #046c4e;
        }
        .admin-btn-taken {
            background-color: #fffbeb;
            color: #b45309; border: 1px solid #fde68a;
        }
        .admin-btn-taken:hover {
            background-color: #fef3c7;
            color: #92400e;
        }
        /* (เพิ่ม) Style สำหรับปุ่มเล็กๆ ในช่อง Pending */
        .mini-action-btn {
            padding: 2px 6px;
            font-size: 11px;
            border-radius: 4px;
            color: white;
            transition: all 0.2s;
        }
        
        /* === (Deleted) Rating Modal Styles (ยกเว้นส่วนที่ยังใช้) === */
        
        /* 6. Rated Display Styles (ยังคงไว้) */
         .rated-text {
            font-size: 0.9rem;
            font-weight: 500;
            color: #6c757d;
         }
        .rated-stars {
            color: #f59e0b;  
            font-size: 1.25rem;
            vertical-align: middle;
        }
        .unrated-stars {
            color: #d1d5db;
            font-size: 1.25rem;
            vertical-align: middle;
        }
        /* === (End Style Section) === */
        
    </style>
</head>
<body>

<div class="app-container">
    <nav id="navbar" class="p-4 border-b border-gray-200 flex justify-between items-center rounded-t-xl bg-white">
        <h1 class="text-2xl font-bold text-gray-800">Laundry Hub</h1>
        <div class="flex space-x-4 items-center">
            
            <div id="nav-tabs" class="space-x-2">
                <button data-target="dashboard-view" class="tab-btn active">Dashboard</button>
                
                <a th:if="${currentUser.role.toString() == 'STUDENT'}"
                   th:href="@{/student/{studentId}/booking(studentId=${currentUser.studentId})}"
                   class="tab-btn">Booking</a>

                <button th:if="${currentUser.role.toString() == 'MANAGER'}" data-target="admin-view" id="nav-admin-link" class="tab-btn">Admin Panel</button>
                </div>

            <span id="user-info" class="text-sm text-gray-600 font-medium sm:inline"
                  th:text="${currentUser.name} + ' (' + ${currentUser.role} + ')'">
                User Name (Role)
            </span>
        </div>
    </nav>

    <div id="message-box" class="fixed top-5 right-5 z-50"></div>

    <div id="dashboard-view" class="view" style="display:block;">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Welcome, <span id="user-display-name" th:text="${currentUser.name}">User</span></h2>

        <div id="student-dashboard" th:if="${currentUser.role.toString() == 'STUDENT'}">

            <div id="active-booking-card" th:if="${activeBooking != null}"
                 class="card !bg-blue-600 text-white mb-8 hover:!bg-blue-700 transition-all cursor-pointer"
                 onclick="window.location.href='/timer'">
                
                <h3 class="text-xl font-semibold mb-2">You have 1 active session!</h3>
                <div class="flex justify-between items-center border-t border-blue-400 pt-3">
                    <div>
                        <p class="font-bold" th:text="${activeBooking.machine.machineNumber}">Washer 1</p>
                        
                        <p class="text-sm opacity-90" th:text="'Status: ' + ${activeBooking.status.displayName}">Status: IN_PROGRESS</p>
                    </div>
                    <span class="text-lg font-bold">Click to View Timer &rarr;</span>
                </div>
            </div>

            <h3 class="text-xl font-semibold mb-4 text-blue-800">Your Upcoming Bookings (Pending)</h3>
            <div id="student-bookings" class="space-y-4">
                
                <div th:if="${#lists.isEmpty(studentBookings)}">
                    <p class="text-gray-500">No active bookings found. Ready to do some laundry?</p>
                </div>
                
                <div th:unless="${#lists.isEmpty(studentBookings)}" th:each="booking : ${studentBookings}"
                     class="card flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-900" th:text="${booking.machine.machineNumber}">Washer 1</p>
                        <p class="text-sm text-gray-600" th:text="'Slot Time: ' + ${#temporals.format(booking.bookingDate, 'dd MMM yyyy, HH:mm')}">Slot Time: 2025-11-03 10:00</p>
                    </div>

                    <span class="text-sm font-semibold px-3 py-1 rounded-full"
                          th:text="${booking.status.displayName}"
                          th:classappend="${booking.status.name == 'CONFIRMED' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700'}">
                        PENDING
                    </span>
                </div>
            </div>
            
            <h3 class="text-xl font-semibold mt-8 mb-4 text-blue-800">Completed History</h3>
            <div id="history-list" class="space-y-4">
                
                <div th:if="${#lists.isEmpty(completedBookings)}">
                     <div class="card">
                         <p class="text-gray-500 text-center">No completed bookings found.</p>
                     </div>
                </div>
                
                <div th:unless="${#lists.isEmpty(completedBookings)}" th:each="booking : ${completedBookings}"
                     class="card flex justify-between items-center">
                    <div>
                        <p class="font-bold text-gray-900" th:text="${booking.machine.machineNumber}">Washer 1</p>
                        <p class="text-sm text-gray-600" th:text="'Slot Time: ' + ${#temporals.format(booking.bookingDate, 'dd MMM yyyy, HH:mm')}">Slot Time: 2025-11-03 10:00</p>
                        <p class="text-sm text-green-600 font-medium">Completed</p>
                    </div>
                    
                    <span th:if="${booking.rating != null}" class="rated-text text-right">
                        <span class="text-sm text-gray-600">Your rating</span><br/>
                        <span class="rated-stars" th:text="${#strings.repeat('★', booking.rating)}"></span>
                        <span class="unrated-stars" th:if="${booking.rating < 5}" th:text="${#strings.repeat('☆', 5 - booking.rating)}"></span>
                    </span>
                </div>
            </div>
            <h3 class="text-xl font-semibold mt-8 mb-4 text-blue-800">Quick Status Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6" id="dashboard-stats">
                <div class="card !bg-blue-500 text-white"><p class="text-sm opacity-80">Total Machines</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.totalMachines}">0</p></div>
                <div class="card !bg-emerald-500 text-white"><p class="text-sm opacity-80">Machines Available</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.availableMachines}">0</p></div>
                <div class="card !bg-amber-500 text-white"><p class="text-sm opacity-80">Machines In Use</p><p class="text-3xl font-bold mt-1" th:text="${studentStats.inUseMachines}">0</p></div>
            </div>

            <p class="mt-8 text-center">
                <a th:href="@{/student/{studentId}/booking(studentId=${currentUser.studentId})}"
                   class="primary-btn">Go to Booking Page</a>
            </p>
        </div>

        <div id="manager-dashboard" th:if="${currentUser.role.toString() == 'MANAGER'}">
            <h3 class="text-xl font-semibold mb-4 text-blue-800">System Overview</h3>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6" id="manager-dashboard-stats">
                <div class="card !bg-blue-500 text-white"><p class="text-sm opacity-80">Total Machines</p><p class="text-3xl font-bold mt-1" th:text="${managerStats.totalMachines}">0</p></div>
                <div class="card !bg-emerald-500 text-white"><p class="text-sm opacity-80">Machines Available</p><p class="text-3xl font-bold mt-1" th:text="${managerStats.availableMachines}">0</p></div>
                <div class="card !bg-amber-500 text-white"><p class="text-sm opacity-80">Machines In Use</p><p class="text-3xl font-bold mt-1" th:text="${managerStats.inUseMachines}">0</p></div>
                <div class="card !bg-red-500 text-white"><p class="text-sm opacity-80">Out of Service</p><p class="text-3xl font-bold mt-1" th:text="${managerStats.maintenanceMachines}">0</p></div>
            </div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mt-8">
                <div class="lg:col-span-2 card">
                    <h3 class="text-xl font-semibold mb-4">Recent Activity (เวลา / ใครใช้)</h3>
                    <div class="space-y-4 max-h-96 overflow-y-auto">
                        <div th:if="${#lists.isEmpty(recentActivities)}">
                            <p class="text-gray-500">No recent activity found.</p>
                        </div>
                        <div th:unless="${#lists.isEmpty(recentActivities)}" th:each="booking : ${recentActivities}"
                             class="flex items-center justify-between p-3 border-b hover:bg-gray-50 rounded-lg">
                            <div class="flex items-center space-x-3">
                                <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold"
                                     th:text="${booking.getCustomerInitial()}">?</div>
                                <div>
                                    <p class="font-bold text-gray-900">
                                        <span th:text="${booking.user.name}">User Name</span>
                                    </p>
                                    <p class="text-sm text-gray-500"
                                       th:text="'Slot Time: ' + ${#temporals.format(booking.bookingDate, 'dd MMM yyyy, HH:mm')}">
                                         Slot Time: 3 Nov 2025, 10:00
                                    </p>
                                </div>
                            </div>
                            
                            <span class="text-sm font-semibold px-3 py-1 rounded-full"
                                  th:text="${booking.status.displayName}"
                                  th:classappend="${booking.status.name == 'COMPLETED' ? 'bg-gray-100 text-gray-600' : (booking.status.name == 'CONFIRMED' ? 'bg-emerald-100 text-emerald-700' : 'bg-amber-100 text-amber-700')}">
                                STATUS
                            </span>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3 class="text-xl font-semibold mb-4">User Overview</h3>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center mb-4">
                            <span class="font-medium text-gray-600">Total Users</span>
                            <span class="text-2xl font-bold text-blue-600" th:text="${managerStats.totalUsers}">0</span>
                        </div>
                        <ul id="admin-user-summary" class="space-y-3 max-h-80 overflow-y-auto">
                            <li th:each="user : ${allUsers}" class="flex justify-between items-center border-t pt-2">
                                <span class="font-medium" th:text="${user.name}">User Name</span>
                                <span class="text-xs font-semibold px-2 py-1 rounded-full"
                                      th:text="${user.role}"
                                      th:classappend="${user.role.toString() == 'MANAGER' ? 'bg-red-100 text-red-700' : 'bg-blue-100 text-blue-700'}">
                                    Role
                                </span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-view" class="view" th:if="${currentUser.role.toString() == 'MANAGER'}" style="display:none;">
        <h2 class="text-3xl font-bold mb-6 text-gray-800">Manager Administration Panel</h2>

        <div class="card mb-8">
            <h3 class="text-xl font-semibold mb-4">Today's Schedule Management (ควบคุมเวลา)</h3>
            <div id="admin-schedule-list" class="space-y-4 max-h-[60vh] overflow-y-auto">
                <p>Loading schedule...</p>
            </div>
        </div>

        <div class="card">
            <h3 class="text-xl font-semibold mb-4">Machine Status Control (สถานะเครื่อง)</h3>
            <div id="admin-machine-list" class="space-y-4">
                <div th:each="machine : ${allMachines}" class="flex items-center justify-between p-3 border-b hover:bg-gray-50 rounded-lg transition duration-150">
                    <div class="flex-grow">
                        <p class="font-bold">
                            <a th:href="@{/machine/{id}(id=${machine.id})}"
                            class="text-blue-600 hover:text-blue-800 hover:underline"
                            th:text="${machine.name} + ' (' + ${machine.machineNumber} + ')'"></a>
                            Washer 1 (001)
                            </a>
                            </p>
                        <p class="text-sm"
                           th:text="'Current: ' + ${machine.status}"
                           th:classappend="${machine.status == 'AVAILABLE' ? 'text-emerald-600' : 'text-red-600'}">
                            Current: Status
                        </p>
                    </div>
                    <div class="flex items-center">
                        <select th:data-id="${machine.id}" class="machine-status-select border border-gray-300 rounded-md p-1 text-sm mr-4 w-40">
                            <option
                                    th:value="'AVAILABLE'"
                                    th:text="'AVAILABLE'"
                                    th:selected="${'AVAILABLE' == machine.status}">
                                AVAILABLE
                            </option>
                            <option
                                    th:value="'OUT_OF_SERVICE'"
                                    th:text="'OUT_OF_SERVICE'"
                                    th:selected="${'OUT_OF_SERVICE' == machine.status}">
                                OUT_OF_SERVICE
                            </option>
                        </select>
                        <button th:data-id="${machine.id}" class="update-machine-btn primary-btn">Update</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    const csrfToken = /*[[${_csrf?.token}]]*/ null;
    const csrfHeader = /*[[${_csrf?.headerName}]]*/ null;
    var allMachines = /*[[${allMachines}]]*/ [];
    var todaysBookings = /*[[${todaysBookings}]]*/ [];
    const currentManager = /*[[${currentUser}]]*/ null;

    function showMessage(message, type = 'info') {
        const baseClass = "p-4 mb-2 rounded-lg shadow-lg text-white font-semibold transition-opacity duration-300";
        let colorClass = type === 'success' ? 'bg-emerald-500' : (type === 'error' ? 'bg-red-500' : 'bg-blue-500');
        const $msg = $(`<div class="${baseClass} ${colorClass}">${message}</div>`);
        $('#message-box').append($msg);
        $msg.fadeIn(300).delay(3000).fadeOut(500, function() { $(this).remove(); });
    }

    function showView(viewId) {
        $('.view').hide();
        $(`#${viewId}`).show();
        $('#nav-tabs .tab-btn').removeClass('active');
        $(`#nav-tabs .tab-btn[data-target="${viewId}"]`).addClass('active');
    }

    $(document).on('click', '.update-machine-btn', function() {
        const $btn = $(this);
        const machineId = $btn.data('id');
        const $select = $(`.machine-status-select[data-id="${machineId}"]`);
        const newStatus = $select.val();
        if (!machineId) return;

        $btn.text('Saving...').prop('disabled', true);

        $.ajax({
            type: 'PUT',
            url: '/api/machines/' + machineId + '/status',
            contentType: 'application/x-www-form-urlencoded',
            data: { status: newStatus },
            dataType: 'json',
            beforeSend: function(xhr) { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken); },
            success: function(response) {
                const returnedStatus = response.status || newStatus;
                showMessage(`${response.name} status updated to: ${returnedStatus}`, 'success');
                const $statusText = $btn.closest('.flex').find('p.text-sm');
                $statusText.text('Current: ' + returnedStatus);
                $statusText.removeClass('text-emerald-600 text-red-600');
                $statusText.addClass(response.status === 'AVAILABLE' ? 'text-emerald-600' : 'text-red-600');
                const machineIndex = allMachines.findIndex(m => m.id === machineId);
                if (machineIndex > -1) { allMachines[machineIndex].status = returnedStatus; }
                renderAdminSchedule();
            },
            error: function(xhr) {
                const errorMsg = xhr.responseJSON ? (xhr.responseJSON.message || xhr.responseJSON.error) : 'Update failed.';
                showMessage(errorMsg, 'error');
            },
            complete: function() {
                $btn.text('Update').prop('disabled', false);
            }
        });
    });

    function getTodaysDateString() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }

    // --- (ฟังก์ชัน Render ที่แก้ไขแล้ว: มีปุ่ม ตกลง/ยกเลิก) ---
    function renderAdminSchedule() {
        const $list = $("#admin-schedule-list").empty();
        const todayStr = getTodaysDateString();

        const bookingLookup = new Map();
        todaysBookings.forEach(booking => {
            if (booking.machine && booking.bookingDate) {
                const key = `${booking.machine.id}-${booking.bookingDate}`;
                bookingLookup.set(key, booking);
            }
        });

        const timeSlots = ["08:00", "09:00", "10:00", "11:00", "12:00", "13:00", "14:00", "15:00", "16:00"];
        let hasAvailableMachines = false;

        allMachines.forEach(machine => {
            if (machine.status === 'OUT_OF_SERVICE') { return; }
            hasAvailableMachines = true;
            let slotButtonsHTML = "";

            timeSlots.forEach(slotTime => {
                const isoSlotTime = `${todayStr}T${slotTime}:00`;
                const lookupKey = `${machine.id}-${isoSlotTime}`;
                const booking = bookingLookup.get(lookupKey);

                let userName = "Unknown";
                if (booking && booking.user) {
                     userName = booking.user.name;
                     if(booking.user.id === currentManager.id) userName = "ADMIN BLOCK";
                }

                if (booking) {
                    
                    if (booking.status.name === 'PENDING') {
                        // --- (กรณีรออนุมัติ: แสดง 2 ปุ่ม) ---
                        slotButtonsHTML += `
                            <div class="text-center bg-yellow-50 p-2 rounded-lg border border-yellow-200">
                                <div class="text-xs font-bold text-yellow-800 mb-1">${slotTime}</div>
                                <div class="text-xs text-gray-600 mb-2 truncate">${userName}</div>
                                <div class="flex justify-center space-x-1">
                                    <button class="mini-action-btn bg-green-500 hover:bg-green-600 btn-approve-booking"
                                            data-booking-id="${booking.id}" title="confirm">
                                        ✓ confirm
                                    </button>
                                    <button class="mini-action-btn bg-red-500 hover:bg-red-600 btn-reject-booking"
                                            data-booking-id="${booking.id}" title="cancel">
                                        ✕ cancel
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        // --- (กรณีกำลังใช้งาน: แสดงปุ่ม Cancel เดิม) ---
                        slotButtonsHTML += `
                            <div class="text-center">
                                <span class="text-xs font-semibold text-gray-700">${slotTime}</span>
                                <button class="admin-slot-btn admin-btn-taken w-full mt-1 btn-cancel-booking"
                                        data-booking-id="${booking.id}">
                                    IN USE: ${userName}
                                </button>
                            </div>
                        `;
                    }
                } else {
                    // (ว่าง)
                    slotButtonsHTML += `
                        <div class="text-center">
                            <span class="text-xs font-semibold text-gray-700">${slotTime}</span>
                            <button class="admin-slot-btn admin-btn-available w-full mt-1 btn-block-slot"
                                    data-machine-id="${machine.id}"
                                    data-slot-time="${isoSlotTime}">
                                AVAILABLE
                            </button>
                        </div>
                    `;
                }
            });

            const machineCardHTML = `
                <div class="card p-4 border-b">
                    <h4 class="font-bold text-gray-800 mb-3">
                        <a href="/machine/${machine.id}"
                        class="text-blue-600 hover:text-blue-800 hover:underline"
                        title="View Details for ${machine.name}">
                        ${machine.name} (${machine.machineNumber})
                        </a>
                        </h4>
                        <div class="grid grid-cols-5 gap-3">
                        ${slotButtonsHTML}
                    </div>
                </div>
            `;
            $list.append(machineCardHTML);
        });

        if (!hasAvailableMachines) {
            $list.html('<p class="text-gray-500">All machines are currently out of service.</p>');
        }
    }

    // --- (ฟังก์ชันปุ่ม [✓ ตกลง] - ปรับปรุงแล้ว) ---
    $(document).on('click', '.btn-approve-booking', function() {
        const $btn = $(this);
        const bookingId = $btn.data('booking-id');
        
        if (!confirm("ยืนยันการอนุมัติ? (เริ่มจับเวลา 60 นาที)")) return;

        // ป้องกันการกดซ้ำ
        $btn.prop('disabled', true).text('...');

        $.ajax({
            type: 'POST',
            url: '/api/bookings/' + bookingId + '/approve',
            dataType: 'json',
            beforeSend: function(xhr) { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken); },
            success: function(updatedBooking) {
                showMessage('อนุมัติเรียบร้อย! เริ่มจับเวลาแล้ว', 'success');
                // อัปเดตข้อมูลในตาราง local
                const index = todaysBookings.findIndex(b => b.id === bookingId);
                if (index > -1) {
                    
                    // The 'updatedBooking' response has 'status' which is the BookingStatus object
                    // So we can just assign it directly.
                    todaysBookings[index].status = updatedBooking.status;
                }
                renderAdminSchedule();
            },
            error: function(xhr) {
                console.error("Approve failed:", xhr.responseText);
                // แม้จะ Error แต่ถ้าสถานะเปลี่ยนไปแล้วจริงๆ (เช่น 200 OK แต่ JSON ผิดพลาด)
                // เราอาจจะลองรีโหลดหน้านี้ดู
                if (xhr.status === 200) {
                    showMessage('อนุมัติสำเร็จ (โปรดรีโหลดหน้าจอหากข้อมูลไม่ตรง)', 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    const errorMsg = xhr.responseJSON ? (xhr.responseJSON.message || xhr.responseJSON.error) : 'เกิดข้อผิดพลาดในการอนุมัติ';
                    showMessage(errorMsg, 'error');
                    $btn.prop('disabled', false).text('✓ ตกลง');
                }
            }
        });
    });

    // --- (ฟังก์ชันปุ่ม [✕ ยกเลิก] - ใช้ร่วมกับ Cancel เดิม) ---
    $(document).on('click', '.btn-reject-booking, .btn-cancel-booking', function() {
        const $btn = $(this);
        const bookingId = $btn.data('booking-id');
        if (!confirm("ยืนยันการยกเลิกการจองนี้?")) return;
        
        $btn.prop('disabled', true).text('...');

        $.ajax({
            type: 'DELETE',
            url: '/api/bookings/' + bookingId,
            beforeSend: function(xhr) { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken); },
            success: function() {
                showMessage('ยกเลิกการจองเรียบร้อย', 'success');
                todaysBookings = todaysBookings.filter(b => b.id !== bookingId);
                renderAdminSchedule();
            },
            error: function(xhr) {
                showMessage('ไม่สามารถยกเลิกได้', 'error');
                $btn.prop('disabled', false); // คืนสถานะปุ่ม
                renderAdminSchedule(); // วาดใหม่เพื่อความชัวร์
            }
        });
    });

    // (ฟังก์ชัน Block Slot - เหมือนเดิม)
    $(document).on('click', '.btn-block-slot', function() {
        const $btn = $(this);
        const machineId = $btn.data('machine-id');
        const slotTime = $btn.data('slot-time');

        if (!confirm("Block this slot?")) return;
        $btn.text('...').prop('disabled', true);

        const bookingData = {
            user: { id: currentManager.id },
            machine: { id: machineId },
            bookingDate: slotTime,
            amount: 0.0,
            service: "ADMIN_BLOCK",
            
            status: {
                name: "CONFIRMED",
                displayName: "Confirmed"
            }
        };

        $.ajax({
            type: 'POST',
            url: '/api/bookings',
            contentType: 'application/json',
            data: JSON.stringify(bookingData),
            dataType: 'json',
            beforeSend: function(xhr) { if (csrfHeader && csrfToken) xhr.setRequestHeader(csrfHeader, csrfToken); },
            success: function(newBooking) {
                showMessage('ปิดกั้นช่วงเวลาสำเร็จ', 'success');
                newBooking.user = currentManager;
                newBooking.machine = allMachines.find(m => m.id === machineId);
                todaysBookings.push(newBooking);
                renderAdminSchedule();
            },
            error: function(xhr) {
                showMessage('เกิดข้อผิดพลาดในการปิดกั้น', 'error');
                $btn.text('AVAILABLE').prop('disabled', false);
            }
        });
    });

    $(document).ready(function() {
        $(document).on('click', '#nav-tabs button.tab-btn', function() {
            const target = $(this).data('target');
            showView(target);
        });
        $('#nav-tabs button.tab-btn[data-target="dashboard-view"]').addClass('active');
        if(currentManager && currentManager.role === 'MANAGER') {
            renderAdminSchedule();
        }
        
        
        // --- (4) DELETED: Rating Modal Logic ---
        
    });

</script>
</body>
</html>